<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯†å®¤é€ƒè„± - ç¥ç§˜æˆ¿é—´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
            line-height: 1.6;
            padding: 20px;
        }

        .game-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #2a2a2a;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .game-title {
            color: #3498db;
            font-size: 24px;
        }

        .game-controls {
            display: flex;
            gap: 10px;
        }

        .control-button {
            background: #3498db;
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-button:hover {
            background: #2980b9;
        }

        .scene-description {
            background-color: #333;
            padding: 40px 20px 20px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            position: relative;
        }

        .hint-button {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            background: rgba(231, 76, 60, 0.8);
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            z-index: 10;
            font-size: 14px;
        }

        .hint-button:hover {
            background: rgba(231, 76, 60, 1);
        }

        .interaction-area {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .action-button {
            background: #444;
            border: none;
            color: white;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .action-button:hover {
            background: #555;
            transform: translateY(-2px);
        }

        .action-button h3 {
            color: #3498db;
        }

        .inventory {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .inventory-title {
            margin-bottom: 10px;
            color: #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .inventory-items {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .inventory-item {
            background: #444;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .inventory-item:hover {
            background: #555;
            transform: translateY(-2px);
        }

        .item-icon {
            font-size: 20px;
        }

        .message-log {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .message.success {
            background: #27ae60;
        }

        .message.error {
            background: #c0392b;
        }

        .message.info {
            background: #2980b9;
        }

        .message.hint {
            background: #e67e22;
        }

        .message-icon {
            font-size: 20px;
        }

        .input-area {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .password-input {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: #444;
            color: white;
            font-size: 16px;
        }

        .submit-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #3498db;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submit-button:hover {
            background: #2980b9;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
        }

        .modal-title {
            color: #3498db;
            margin-bottom: 15px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .sound-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .sound-button {
            background: rgba(52, 152, 219, 0.5);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s;
        }

        .sound-button:hover {
            background: rgba(52, 152, 219, 0.8);
        }

        .sound-button.muted {
            background: rgba(231, 76, 60, 0.5);
        }

        .progress-bar {
            background: #333;
            height: 5px;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress {
            background: #3498db;
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }

        .tutorial-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            width: 90%;
        }

        .tutorial-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            text-align: center;
        }

        .tutorial-icon {
            font-size: 24px;
        }

        .tutorial-next {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tutorial-next:hover {
            background: #2980b9;
        }

        .tutorial-highlight {
            animation: highlight-pulse 2s infinite;
            position: relative;
            z-index: 100;
        }

        @keyframes highlight-pulse {
            0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(52, 152, 219, 0); }
            100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
        }

        .home-button {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #e74c3c;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
        }

        .home-button:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .return-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .return-modal .modal-content {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-button {
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-button.confirm {
            background: #e74c3c;
            color: white;
        }

        .modal-button.cancel {
            background: #7f8c8d;
            color: white;
        }
    </style>
</head>
<body>
    <button class="home-button" onclick="confirmReturn()">
        <span>ğŸ </span>è¿”å›ä¸»é¡µ
    </button>

    <div class="game-container">
        <div class="game-header">
            <h1 class="game-title">ç¥ç§˜æˆ¿é—´</h1>
            <div class="game-controls">
                <button class="control-button" onclick="saveGame()">ä¿å­˜æ¸¸æˆ</button>
                <button class="control-button" onclick="loadGame()">è¯»å–å­˜æ¡£</button>
                <button class="control-button" onclick="restartGame()">é‡æ–°å¼€å§‹</button>
            </div>
        </div>

        <div class="scene-description">
            <button class="hint-button" onclick="showHint()">è·å–æç¤º</button>
            <p id="scene-text">ä½ é†’æ¥å‘ç°è‡ªå·±åœ¨ä¸€ä¸ªé™Œç”Ÿçš„æˆ¿é—´é‡Œã€‚æˆ¿é—´ä¸å¤§,å…‰çº¿æ˜æš—,åªæœ‰ä¸€ç›å°ç¯æä¾›ç…§æ˜ã€‚å››å‘¨çš„å¢™å£ä¸Šè´´ç€è€æ—§çš„å£çº¸,æˆ¿é—´ä¸­å¤®æ”¾ç€ä¸€å¼ æœ¨æ¡Œ,è§’è½é‡Œæœ‰ä¸€ä¸ªä¸Šé”çš„æŸœå­ã€‚</p>
            <div class="progress-bar">
                <div class="progress" id="progress-bar"></div>
            </div>
        </div>

        <div class="interaction-area">
            <button class="action-button" onclick="examineDesk()">
                <h3>æ£€æŸ¥æœ¨æ¡Œ</h3>
                <p>ä»”ç»†æŸ¥çœ‹æ¡Œé¢ä¸Šçš„ç‰©å“</p>
            </button>
            <button class="action-button" onclick="examineCabinet()">
                <h3>æ£€æŸ¥æŸœå­</h3>
                <p>è§‚å¯Ÿä¸Šé”çš„æŸœå­</p>
            </button>
            <button class="action-button" onclick="examineWallpaper()">
                <h3>æ£€æŸ¥å£çº¸</h3>
                <p>æŸ¥çœ‹å¢™ä¸Šçš„å£çº¸</p>
            </button>
            <button class="action-button" onclick="examineLamp()">
                <h3>æ£€æŸ¥å°ç¯</h3>
                <p>æŸ¥çœ‹å‘å…‰çš„å°ç¯</p>
            </button>
        </div>

        <div class="inventory">
            <div class="inventory-title">
                <h3>ç‰©å“æ </h3>
                <span id="item-count">0/6</span>
            </div>
            <div class="inventory-items" id="inventory">
                <!-- ç‰©å“å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
            </div>
        </div>

        <div class="input-area">
            <input type="text" class="password-input" id="password-input" placeholder="è¾“å…¥å¯†ç ...">
            <button class="submit-button" onclick="checkPassword()">ç¡®è®¤</button>
        </div>

        <div class="message-log" id="message-log">
            <!-- æ¶ˆæ¯å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
        </div>
    </div>

    <div class="sound-controls">
        <button class="sound-button" onclick="toggleMusic()" id="music-button">ğŸµ</button>
        <button class="sound-button" onclick="toggleSound()" id="sound-button">ğŸ”Š</button>
    </div>

    <!-- æç¤ºæ¡† -->
    <div class="modal" id="hint-modal">
        <div class="modal-content">
            <h2 class="modal-title">æ¸¸æˆæç¤º</h2>
            <p id="hint-text"></p>
            <div class="modal-buttons">
                <button class="control-button" onclick="closeModal('hint-modal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- å­˜æ¡£ç¡®è®¤æ¡† -->
    <div class="modal" id="save-modal">
        <div class="modal-content">
            <h2 class="modal-title">ä¿å­˜æ¸¸æˆ</h2>
            <p>ç¡®å®šè¦ä¿å­˜å½“å‰æ¸¸æˆè¿›åº¦å—ï¼Ÿ</p>
            <div class="modal-buttons">
                <button class="control-button" onclick="confirmSave()">ç¡®å®š</button>
                <button class="control-button" onclick="closeModal('save-modal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ ç¡®è®¤è¿”å›æ¨¡æ€æ¡† -->
    <div class="return-modal" id="return-modal">
        <div class="modal-content">
            <h3>ç¡®è®¤è¿”å›</h3>
            <p>ç¡®å®šè¦è¿”å›ä¸»é¡µå—ï¼Ÿå½“å‰æ¸¸æˆè¿›åº¦å°†ä¸ä¼šä¿å­˜ã€‚</p>
            <div class="modal-buttons">
                <button class="modal-button confirm" onclick="returnToHome()">ç¡®å®šè¿”å›</button>
                <button class="modal-button cancel" onclick="closeReturnModal()">ç»§ç»­æ¸¸æˆ</button>
            </div>
        </div>
    </div>

    <audio id="bgm" loop>
        <source src="https://example.com/background.mp3" type="audio/mpeg">
    </audio>

    <script>
        // æ¸¸æˆçŠ¶æ€
        const gameState = {
            inventory: new Set(),
            examinedObjects: new Set(),
            cabinetUnlocked: false,
            lampOn: true,
            hasKey: false,
            gameComplete: false,
            hintsUsed: 0,
            progress: 0,
            soundEnabled: true,
            musicEnabled: true,
            tutorialStep: 0,  // æ·»åŠ æ•™å­¦æ­¥éª¤è®¡æ•°
            tutorialComplete: false  // æ•™å­¦å®Œæˆæ ‡è®°
        };

        // éŸ³æ•ˆ
        const sounds = {
            pickup: new Audio('https://example.com/pickup.mp3'),
            unlock: new Audio('https://example.com/unlock.mp3'),
            success: new Audio('https://example.com/success.mp3'),
            error: new Audio('https://example.com/error.mp3')
        };

        // æç¤ºä¿¡æ¯
        const hints = [
            "è¯•è¯•æ£€æŸ¥æˆ¿é—´é‡Œçš„ç‰©å“,å¯èƒ½ä¼šå‘ç°æœ‰ç”¨çš„çº¿ç´¢ã€‚",
            "åœ¨ç‰©å“æ ä¸­ç‚¹ï¿½ï¿½ï¿½ç‰©å“å¯ä»¥æŸ¥çœ‹æˆ–ä½¿ç”¨å®ƒã€‚",
            "è®°ä½çœ‹åˆ°çš„æ•°å­—,å¯èƒ½å°±æ˜¯æœ€ç»ˆå¯†ç ã€‚",
            "å¦‚æœæ‰¾åˆ°é’¥åŒ™,å°±å¯ä»¥ç”¨æ¥å¼€é”ã€‚"
        ];

        // æ•™å­¦æ­¥éª¤æç¤º
        const tutorialSteps = [
            {
                text: "æ¬¢è¿æ¥åˆ°å¯†å®¤é€ƒè„±æ¸¸æˆï¼è¿™æ˜¯ä¸€ä¸ªæ•™å­¦å…³å¡ï¼Œè·Ÿç€æç¤ºä¸€æ­¥æ­¥å­¦ä¹ æ¸¸æˆæ“ä½œã€‚",
                target: null
            },
            {
                text: "é¦–å…ˆ,è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹æœ¨æ¡Œã€‚ç‚¹å‡»'æ£€æŸ¥æœ¨æ¡Œ'æŒ‰é’®ã€‚",
                target: "desk"
            },
            {
                text: "å¾ˆå¥½ï¼ä½ æ‰¾åˆ°äº†ä¸€å¼ çº¸æ¡ã€‚ç‚¹å‡»ç‰©å“æ ä¸­çš„çº¸æ¡å¯ä»¥æŸ¥çœ‹å†…å®¹ã€‚",
                target: "note"
            },
            {
                text: "çº¸æ¡ä¸Šå†™ç€æ•°å­—2591ã€‚è®©æˆ‘ä»¬ç»§ç»­æ¢ç´¢,æ£€æŸ¥ä¸€ä¸‹å¢™ä¸Šçš„å£çº¸ã€‚",
                target: "wallpaper"
            },
            {
                text: "ä½ æ‰¾åˆ°äº†ä¸€æŠŠé’¥åŒ™ï¼è¯•è¯•ç”¨å®ƒæ¥æ‰“å¼€æŸœå­ã€‚ç‚¹å‡»ç‰©å“æ ä¸­çš„é’¥åŒ™ã€‚",
                target: "key"
            },
            {
                text: "æŸœå­æ‰“å¼€äº†ï¼é‡Œé¢æœ‰ä¸€ä¸ªæç¤ºï¼š'æœ€ç»ˆå¯†ç å°±æ˜¯çº¸æ¡ä¸Šçš„æ•°å­—'ã€‚",
                target: "cabinet"
            },
            {
                text: "ç°åœ¨ä½ çŸ¥é“å¯†ç ï¿½ï¿½,åœ¨ä¸‹æ–¹è¾“å…¥æ¡†è¾“å…¥2591è¯•è¯•çœ‹ï¼",
                target: "password"
            }
        ];

        // æ·»åŠ æ¶ˆæ¯åˆ°æ—¥å¿—
        function addMessage(text, type = 'info') {
            const messageLog = document.getElementById('message-log');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            
            // æ·»åŠ å›¾æ ‡
            const icon = document.createElement('span');
            icon.className = 'message-icon';
            switch(type) {
                case 'success': icon.textContent = 'âœ“'; break;
                case 'error': icon.textContent = 'âœ—'; break;
                case 'hint': icon.textContent = 'ğŸ’¡'; break;
                default: icon.textContent = 'â„¹';
            }
            
            const content = document.createElement('span');
            content.textContent = text;
            
            message.appendChild(icon);
            message.appendChild(content);
            messageLog.appendChild(message);
            messageLog.scrollTop = messageLog.scrollHeight;

            // æ’­æ”¾éŸ³æ•ˆ
            if (gameState.soundEnabled) {
                switch(type) {
                    case 'success': sounds.success.play(); break;
                    case 'error': sounds.error.play(); break;
                }
            }
        }

        // æ·»åŠ ç‰©å“åˆ°ç‰©å“æ 
        function addItem(item, icon = 'ğŸ“¦') {
            if (!gameState.inventory.has(item)) {
                gameState.inventory.add(item);
                const inventory = document.getElementById('inventory');
                const itemElement = document.createElement('div');
                itemElement.className = 'inventory-item';
                
                const itemIcon = document.createElement('span');
                itemIcon.className = 'item-icon';
                itemIcon.textContent = icon;
                
                const itemName = document.createElement('span');
                itemName.textContent = item;
                
                itemElement.appendChild(itemIcon);
                itemElement.appendChild(itemName);
                itemElement.onclick = () => useItem(item);
                inventory.appendChild(itemElement);
                
                updateItemCount();
                updateProgress();
                
                if (gameState.soundEnabled) {
                    sounds.pickup.play();
                }
                
                addMessage(`è·å¾—äº† ${item}`, 'success');
            }
        }

        // æ›´æ–°ç‰©å“æ•°é‡æ˜¾ç¤º
        function updateItemCount() {
            const itemCount = document.getElementById('item-count');
            itemCount.textContent = `${gameState.inventory.size}/6`;
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress() {
            const totalSteps = 6; // æ€»æ­¥éª¤æ•°
            const completedSteps = gameState.inventory.size + 
                                 (gameState.cabinetUnlocked ? 1 : 0) + 
                                 (gameState.gameComplete ? 1 : 0);
            
            const progress = (completedSteps / totalSteps) * 100;
            gameState.progress = progress;
            
            document.getElementById('progress-bar').style.width = `${progress}%`;
        }

        // ä½¿ç”¨ç‰©å“
        function useItem(item) {
            if (item === 'é’¥åŒ™' && !gameState.cabinetUnlocked) {
                gameState.cabinetUnlocked = true;
                if (gameState.soundEnabled) {
                    sounds.unlock.play();
                }
                addMessage('ä½ ç”¨é’¥åŒ™æ‰“å¼€äº†æŸœå­!', 'success');
                addMessage('åœ¨æŸœå­é‡Œå‘ç°äº†ä¸€ä¸ªæç¤ºï¼šæœ€ç»ˆå¯†ç å°±æ˜¯çº¸æ¡ä¸Šçš„æ•°å­—ã€‚', 'info');
                updateProgress();
                updateTutorial(4);
            } else if (item === 'çº¸æ¡') {
                addMessage('çº¸æ¡ä¸Šå†™ç€æ•°å­—ï¼š2591', 'info');
                addMessage('è¿™çœ‹èµ·æ¥åƒæ˜¯æŸç§å¯†ç ...', 'info');
                updateTutorial(2);
            } else {
                addMessage('è¿™ä¸ªç‰©å“ç°åœ¨æ²¡æœ‰ç”¨å¤„...', 'error');
            }
        }

        // æ£€æŸ¥æœ¨æ¡Œ
        function examineDesk() {
            if (!gameState.examinedObjects.has('desk')) {
                gameState.examinedObjects.add('desk');
                addMessage('ä½ ä»”ç»†æ£€æŸ¥äº†æœ¨æ¡Œ,åœ¨æ¡Œå­åº•éƒ¨å‘ç°äº†ä¸€å¼ çº¸æ¡ã€‚', 'info');
                addItem('çº¸æ¡', 'ğŸ“');
                updateTutorial(1);  // æ›´æ–°æ•™å­¦è¿›åº¦
            } else {
                addMessage('ä½ å·²ç»æ£€æŸ¥è¿‡æœ¨æ¡Œäº†,æ²¡æœ‰æ–°çš„å‘ç°ã€‚');
            }
        }

        // æ£€æŸ¥æŸœå­
        function examineCabinet() {
            if (gameState.cabinetUnlocked) {
                addMessage('æŸœå­å·²ç»æ‰“å¼€äº†,é‡Œé¢ç©ºç©ºå¦‚ä¹Ÿã€‚');
            } else {
                addMessage('æŸœå­ä¸Šäº†é”,éœ€è¦æ‰¾åˆ°é’¥åŒ™ã€‚');
            }
        }

        // æ£€æŸ¥å£çº¸
        function examineWallpaper() {
            if (!gameState.examinedObjects.has('wallpaper')) {
                gameState.examinedObjects.add('wallpaper');
                addMessage('ä½ æ³¨æ„åˆ°å£çº¸æœ‰ä¸€å¤„å¾®å¾®é¼“èµ·,æ€å¼€åå‘ç°äº†ä¸€æŠŠé’¥åŒ™!', 'info');
                addItem('é’¥åŒ™', 'ğŸ”‘');
                updateTutorial(3);  // æ›´æ–°æ•™å­¦è¿›åº¦
            } else {
                addMessage('å£çº¸å·²ç»è¢«ä½ æ£€æŸ¥è¿‡äº†ã€‚');
            }
        }

        // æ£€æŸ¥å°ç¯
        function examineLamp() {
            if (gameState.lampOn) {
                gameState.lampOn = false;
                addMessage('ä½ å…³é—­äº†å°ç¯ã€‚æˆ¿é—´å˜å¾—æœ‰äº›æ˜æš—ã€‚', 'info');
            } else {
                gameState.lampOn = true;
                addMessage('ä½ æ‰“å¼€äº†å°ç¯ã€‚', 'info');
            }
        }

        // æ£€æŸ¥å¯†ç 
        function checkPassword() {
            const input = document.getElementById('password-input');
            const password = input.value.trim();

            if (password === '2591') {
                if (!gameState.gameComplete) {
                    gameState.gameComplete = true;
                    gameState.tutorialComplete = true;
                    addMessage('å¯†ç æ­£ç¡®!é—¨å¼€äº†,ä½ æˆåŠŸå®Œæˆäº†æ•™å­¦å…³å¡!', 'success');
                    addMessage('ä½ å·²ç»æŒæ¡äº†åŸºæœ¬æ“ä½œï¼šæ£€æŸ¥ç‰©å“ã€ä½¿ç”¨ç‰©å“ã€è¾“å…¥å¯†ç ã€‚å‡†å¤‡å¥½è¿æ¥ä¸‹ä¸€å…³çš„æŒ‘æˆ˜äº†å—ï¼Ÿ', 'info');
                    showNextLevelPrompt();
                    updateProgress();
                }
            } else {
                addMessage('å¯†ç é”™è¯¯,å†æƒ³æƒ³çº¸æ¡ä¸Šçš„æ•°å­—ã€‚', 'error');
            }
            input.value = '';
        }

        // æ˜¾ç¤ºæç¤º
        function showHint() {
            const modal = document.getElementById('hint-modal');
            const hintText = document.getElementById('hint-text');
            const currentHint = hints[gameState.hintsUsed % hints.length];
            hintText.textContent = currentHint;
            modal.style.display = 'flex';
            gameState.hintsUsed++;
            addMessage('ä½¿ç”¨äº†æç¤ºã€‚', 'hint');
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ä¿å­˜æ¸¸æˆ
        function saveGame() {
            document.getElementById('save-modal').style.display = 'flex';
        }

        // ç¡®è®¤ä¿å­˜
        function confirmSave() {
            const saveData = {
                inventory: Array.from(gameState.inventory),
                examinedObjects: Array.from(gameState.examinedObjects),
                cabinetUnlocked: gameState.cabinetUnlocked,
                lampOn: gameState.lampOn,
                hasKey: gameState.hasKey,
                gameComplete: gameState.gameComplete,
                hintsUsed: gameState.hintsUsed,
                progress: gameState.progress
            };
            
            localStorage.setItem('escapeRoomSave', JSON.stringify(saveData));
            addMessage('æ¸¸æˆå·²ä¿å­˜ã€‚', 'success');
            closeModal('save-modal');
        }

        // åŠ è½½æ¸¸æˆ
        function loadGame() {
            const saveData = localStorage.getItem('escapeRoomSave');
            if (saveData) {
                const data = JSON.parse(saveData);
                
                // æ¸…ç©ºå½“å‰çŠ¶æ€
                gameState.inventory.clear();
                gameState.examinedObjects.clear();
                document.getElementById('inventory').innerHTML = '';
                
                // æ¢å¤å­˜æ¡£çŠ¶æ€
                data.inventory.forEach(item => addItem(item));
                data.examinedObjects.forEach(obj => gameState.examinedObjects.add(obj));
                gameState.cabinetUnlocked = data.cabinetUnlocked;
                gameState.lampOn = data.lampOn;
                gameState.hasKey = data.hasKey;
                gameState.gameComplete = data.gameComplete;
                gameState.hintsUsed = data.hintsUsed;
                gameState.progress = data.progress;
                
                updateProgress();
                addMessage('æ¸¸æˆå·²è¯»å–ã€‚', 'success');
            } else {
                addMessage('æ²¡æœ‰æ‰¾åˆ°å­˜æ¡£ã€‚', 'error');
            }
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            location.reload();
        }

        // éŸ³ä¹æ§åˆ¶
        function toggleMusic() {
            const bgm = document.getElementById('bgm');
            const musicButton = document.getElementById('music-button');
            
            gameState.musicEnabled = !gameState.musicEnabled;
            if (gameState.musicEnabled) {
                bgm.play();
                musicButton.textContent = 'ğŸµ';
                musicButton.classList.remove('muted');
            } else {
                bgm.pause();
                musicButton.textContent = 'ğŸ”‡';
                musicButton.classList.add('muted');
            }
        }

        // éŸ³æ•ˆæ§åˆ¶
        function toggleSound() {
            const soundButton = document.getElementById('sound-button');
            
            gameState.soundEnabled = !gameState.soundEnabled;
            if (gameState.soundEnabled) {
                soundButton.textContent = 'ğŸ”Š';
                soundButton.classList.remove('muted');
            } else {
                soundButton.textContent = 'ğŸ”‡';
                soundButton.classList.add('muted');
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            addMessage('æ¬¢è¿æ¥åˆ°å¯†å®¤é€ƒè„±æ•™å­¦å…³å¡!', 'info');
            addMessage('è·Ÿéšæç¤ºä¸€æ­¥æ­¥å­¦ä¹ æ¸¸æˆæ“ä½œã€‚', 'info');
            
            // æ·»åŠ æ•™å­¦å±æ€§
            document.querySelector('[onclick="examineDesk()"]').setAttribute('data-tutorial', 'desk');
            document.querySelector('[onclick="examineWallpaper()"]').setAttribute('data-tutorial', 'wallpaper');
            document.querySelector('[onclick="examineLamp()"]').setAttribute('data-tutorial', 'lamp');
            
            // æ˜¾ç¤ºç¬¬ä¸€ä¸ªæ•™å­¦æç¤º
            setTimeout(showTutorial, 1000);
            
            // å°è¯•åŠ è½½èƒŒæ™¯éŸ³ä¹
            const bgm = document.getElementById('bgm');
            bgm.volume = 0.3;
            bgm.play().catch(() => {
                console.log('è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢');
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ¸¸æˆ
        window.addEventListener('load', initGame);

        // å…³é—­æ¨¡æ€æ¡†çš„ç‚¹å‡»äº‹ä»¶
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // æ˜¾ç¤ºæ•™å­¦æç¤º
        function showTutorial() {
            if (gameState.tutorialComplete) return;
            
            const step = tutorialSteps[gameState.tutorialStep];
            if (!step) return;

            const tutorialBox = document.createElement('div');
            tutorialBox.className = 'tutorial-box';
            tutorialBox.innerHTML = `
                <div class="tutorial-content">
                    <span class="tutorial-icon">ğŸ’¡</span>
                    <p>${step.text}</p>
                    <button class="tutorial-next" onclick="this.parentElement.parentElement.remove()">æ˜ç™½äº†</button>
                </div>
            `;
            document.body.appendChild(tutorialBox);

            // é«˜äº®ç›®æ ‡å…ƒç´ 
            if (step.target) {
                const targetElement = document.querySelector(`[data-tutorial="${step.target}"]`);
                if (targetElement) {
                    targetElement.classList.add('tutorial-highlight');
                }
            }
        }

        // æ›´æ–°æ•™å­¦è¿›åº¦
        function updateTutorial(step) {
            if (gameState.tutorialComplete) return;
            
            // ç§»é™¤ä¹‹å‰çš„é«˜äº®
            document.querySelectorAll('.tutorial-highlight').forEach(el => {
                el.classList.remove('tutorial-highlight');
            });

            if (gameState.tutorialStep === step) {
                gameState.tutorialStep++;
                showTutorial();
            }
        }

        // æ˜¾ç¤ºä¸‹ä¸€å…³æç¤º
        function showNextLevelPrompt() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 class="modal-title">æ­å–œé€šå…³ï¼</h2>
                    <p>ä½ å·²ç»æŒæ¡äº†å¯†å®¤é€ƒè„±çš„åŸºæœ¬æŠ€èƒ½ï¼š</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>æ£€æŸ¥æˆ¿é—´å¯»æ‰¾çº¿ç´¢</li>
                        <li>æ”¶é›†å’Œä½¿ç”¨ç‰©å“</li>
                        <li>è¾“å…¥å¯†ç è§£é”</li>
                    </ul>
                    <p>å‡†å¤‡å¥½æ¥å—æ›´å¤§çš„æŒ‘æˆ˜äº†å—ï¼Ÿä¸‹ä¸€å…³å°†ä¼šæœ‰ï¼š</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>å¤šä¸ªæˆ¿é—´æ¢ç´¢</li>
                        <li>ç‰©å“åˆæˆç³»ç»Ÿ</li>
                        <li>æ›´å¤æ‚çš„è°œé¢˜</li>
                        <li>é™æ—¶æŒ‘æˆ˜</li>
                    </ul>
                    <div class="modal-buttons">
                        <button class="control-button" onclick="goToNextLevel()">è¿›å…¥ä¸‹ä¸€å…³</button>
                        <button class="control-button" onclick="this.parentElement.parentElement.parentElement.remove()">ç»§ç»­æ¢ç´¢</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // è·³è½¬åˆ°ä¸‹ä¸€å…³
        function goToNextLevel() {
            window.location.href = 'escape_room.html';  // è·³è½¬åˆ°ä¸‹ä¸€å…³
        }

        // æ·»åŠ ç¡®è®¤è¿”å›å‡½æ•°
        function confirmReturn() {
            document.getElementById('return-modal').style.display = 'flex';
        }

        // æ·»åŠ è¿”å›ä¸»é¡µå‡½æ•°
        function returnToHome() {
            window.location.href = 'index.html';
        }

        // å…³é—­ç¡®è®¤è¿”å›æ¨¡æ€æ¡†
        function closeReturnModal() {
            document.getElementById('return-modal').style.display = 'none';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('return-modal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>